name: Code Quality

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # Format checking for C code only
  format-check:
    name: C Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install clang-format-21
      uses: ./.github/actions/setup-llvm-toolchain
      with:
        llvm-version: '21'
        packages: clang-format-21

    - name: Run C format check script
      run: scripts/check-format-c.sh

  # Static analysis for C code
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install LLVM toolchain
      uses: ./.github/actions/setup-llvm-toolchain
      with:
        llvm-version: '21'
        packages: clang-21 clang-tidy-21 clang-format-21
        create-alternatives: 'true'

    - name: Install additional dependencies
      run: |
        sudo apt-get install -y \
          bear \
          cppcheck \
          libsdl2-dev \
          libsdl2-mixer-dev \
          libpng-dev \
          libzip-dev \
          zlib1g-dev

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        cache: true
        cache-workspaces: astonia_net

    - name: Run static analysis script
      run: scripts/check-static-analysis.sh

    - name: Upload analysis reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: static-analysis-reports
        path: build/logs/*.log
        retention-days: 90

  # Rust formatting check
  rust-format-check:
    name: Rust Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: rustfmt
        cache: true
        cache-workspaces: astonia_net

    - name: Run Rust format check script
      run: scripts/check-format-rust.sh

  # Rust linting (clippy)
  rust-lint-check:
    name: Rust Linting (clippy)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: clippy
        cache: true
        cache-workspaces: astonia_net

    - name: Run Rust linting script
      run: scripts/check-clippy.sh

  # File consistency checks
  file-checks:
    name: File Consistency
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Run file consistency script
      run: scripts/check-files.sh

  # Sanitizer build test
  sanitizer:
    name: AddressSanitizer/UBSan Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install LLVM toolchain
      uses: ./.github/actions/setup-llvm-toolchain
      with:
        llvm-version: '21'
        packages: clang-21
        create-alternatives: 'true'

    - name: Install additional dependencies
      run: |
        sudo apt-get install -y \
          libsdl2-dev \
          libsdl2-mixer-dev \
          libpng-dev \
          libzip-dev \
          zlib1g-dev

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        cache: true
        cache-workspaces: astonia_net

    - name: Build with sanitizers
      run: make sanitizer
      env:
        CC: clang

    - name: Check sanitizer binary
      run: |
        echo "Sanitizer build successful!"
        ls -lh bin/moac-sanitizer
        file bin/moac-sanitizer
